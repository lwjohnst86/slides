---
title: "NetCoupler: Inferring causal pathways between high-dimensional metabolomics data and external factors"
author:
    - Luke W. Johnston
    - Clemens Wittenbecher
    - Fabian Eichelmann
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["useR", "useR-fonts", "extra.css"]
    #css: "xaringan-themer.css"
    nature:
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

layout: true

<!-- To UseR 2021 

Bio:

Diabetes epidemiologist, R teacher, create R packages and tutorials to help researchers do reproducible and open science more easily. Personal site: https://lukewjohnston.com/

Slides are found here: https://slides.lwjohnst.com/user/2021-07-06/

-->

<div class="my-footer">
Slides: <a href="https://slides.lwjohnst.com/user/2021-07-06/">slides.lwjohnst.com/user/2021-07-06</a>
<br>Package: <a href="https://github.com/NetCoupler/NetCoupler/">github.com/NetCoupler/NetCoupler</a>
</div> 

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.align = "center"
)

image_nc_path <- function(.file) {
    fs::path("..", "..", "au-ph", "2019-08-15", "images", .file)
}

image_iarc_path <- function(.file) {
    fs::path("..", "..", "iarc", "2020-12-16", "images", .file)
}

library(xaringanthemer)
xaringanthemer::style_extra_css(
    list(
        "div.my-footer" = list(
            position = "absolute",
            background = "transparent",
            bottom = "0px",
            left = "140px",
            height = "50px",
            "font-size" = "20px"
        ),
        ".remark-slide-content" = list(
            "font-size" = "24px"
        )
    ),
    outfile = "extra.css",
    append = FALSE
)
```

```{r use-logo}
xaringanExtra::use_logo(
  image_url = "../../common/dda-sdca-logos.png",
  width = "110px"
)
```

```{r image-alt-and-cap-text, include=FALSE}
alt_questions_form <- "Diagram showing an exposure variable connected by lines to a network of metabolite variables within circles, that are then connected to an outcome variable."
cap_questions_form <- "Use NetCoupler to answer questions of this form (M = metabolite)."
alt_nc_phases <- "Diagram with four distinct areas representing the phases.
First phase shows a network of nodes called N commnected by lines that has been derived.
Second phase shows one node, called the index node, as an example of being iteratively selected, 
along with the other nodes it is connected to, called neighbour nodes.
Third phase shows a series of diagrams that are calculated for all combinations of
the index node with its neighbouring nodes. There are eight of these diagrams. Each
diagram represents a model for the next phase.
Fourth phase shows that each model from the previous phase is classified into
direct, ambigious, or no effect. This classification happens separately for 
exposures, called E, and outcomes, called O."
cap_nc_phases <- "Overview of the four phases."
alt_nc_pathways <- "
Thicker lines with arrows indicate
"
cap_nc_pathways <- ""
```

<!--

Instructions:

- Timing:
    - 5 min
    - ~100-150 wpm = 500-750 words total
- Video:
    - Show face (picture-in-picture layout)
    - OBS Studio/Simple Screen Recorder
    - Describe headers, graphics
    - Speak each word on slides
    - Describe what and why
- Content:
    - Include speakers notes
    - Include alt-text
    - Include transcript

-->

---

## Designed to identify *potential* causal factors from complex networks

.pull-left[

**Motivation**:

- Moderately high dimensional and complex network data (e.g. metabolomics)
- Derive potential network structure
- Estimate causal pathways:
    - From exposure (e.g. exercise) to network
    - From network to outcome (e.g. diabetes)
    - From exposure to outcome, through the network
]

.pull-right[
```{r img-questions-form, out.width="100%", fig.alt=alt_questions_form, fig.cap=cap_questions_form}
knitr::include_graphics(image_nc_path("network.png"))
```
]

???

---

## Main features of NetCoupler 


.pull-left[
- Finds most likely network structure

- Can include exposure and/or outcome

- Identifies *potential* causal links from, to, and within the network
]

--

.pull-right[
- Flexible in type of model used (e.g. linear, logistic, cox regression)

- Allows adjusting for confounders and covariates

- Results are designed to be visualized (e.g. with tidygraph/ggraph packages)
]

---

## Four basic phases of the algorithm

```{r img-nc-phases, out.width="90%", fig.alt=alt_nc_phases, fig.cap=cap_nc_phases}
knitr::include_graphics(image_iarc_path("netcoupler-process.svg"))
```

???

---

## Simple example of the R code to use

.pull-left[
```{r example-nc-code, eval=FALSE, echo=TRUE}
library(NetCoupler)
std_data <- dataset %>% 
    nc_standardize(
        starts_with("metabolite")
    )

network <- std_data %>% 
    nc_estimate_network(
        starts_with("metabolite")
    ) %>% 
    as_edge_tbl()

outcome_estimates <- std_data %>%
    nc_estimate_outcome_links(
        edge_tbl = network,
        outcome = "HbA1c",
        model_function = lm
    )
```
]

.pull-right[
- Data needs to be standardized

- Need network object to be an edge table (columns for start and end nodes)
]

???

---

## Graphical model output allows visual inference of *potential* pathways

```{r img-nc-pathways, out.width="85%", fig.alt=alt_nc_pathways, fig.cap=cap_nc_pathways}
knitr::include_graphics(image_nc_path("nc-causal-pathways.png"))
```

???


---

## Current limitations and areas of improvement

.pull-left[
- Conceptual:
    - Tricky to visualize (too many paths and variables)
    - Difficult to interpret output estimates
    - Not suited to pure exploration, should have some theoretical basis
    
- Modeling:
    - Heavily relies on p-values
    - Only tested on cross-sectional/time-to-event data
]

--

.pull-right[
- Software:
    - Slow performance
    - Untested on networks with >25 variables
    - Probably not sensible for *very* high-dimensional data (e.g. genomics)
]

???

---

class: middle

# Thanks!

???

Hi everyone, I'm going to be talking about NetCoupler, which is an algorithm and R
package for inferring causal pathways between high-dimensional metabolomics data
and external factors.

We had several motivations for creating NetCoupler.
We wanted to be able to make use of moderately high dimensional and complex
network data such as from metabolomics and to be able to derive the potential
underlying network that we could use to estimate possible causal pathways
from. We wanted to answer questions about potential pathways that an
exposure like exercise might have on a network, that a network might have on an
outcome like diabetes, or that an exposure might have on an outcome, through the
network, all of which is illustrated by the diagram.

With NetCoupler, the main features are that it can find the most likely network
structure, that it can include exposure and/or outcome variables, and that it
can help in identifying potential causal links from, to, and within the metabolic
network. This would then form the basis for exploring these potential links in
further research.

From an implementation point of view, the type of model you can use in
NetCoupler is quite flexible, in that you can use models like linear or logistic
regression or Cox proportional hazard models. Because the algorithm uses these
models, you can also adjust for any potential confounding factors that might
bias the results. And lastly, given the algorithm is based on network graphs,
the results are designed specifically to be visualized, such as with the
tidygraph or ggraph packages.

There are four basic phases of the NetCoupler algorithm that are illustrated in
this diagram.

The first phase is that the structure of the metabolic network is derived using
the established causal structure learning PC-algorthm. 

The second phase is where
each metabolic variable, called a node, within the network is iteratively
selected, represented as an index node, along with its connected neighbouring
nodes. In this case, the selected index node has three neighbours.

The third phase is where each possible combination of index with neighbouring
node is calculated and later each combination is set as a model. 
Since there are three neighbours here, that would be eight different possible 
combinations representing eight models.

The fourth phase is taking all these models and linking them with either
an exposure variable or an outcome. Based on some specific threshold,
the link between exposure or outcome and the index node is classified as
either direct, ambigious, or no effect.

Here is a very simple example of how NetCoupler would be used in R. More details
are found on the NetCoupler website linked in the footer, so I'll only briefly 
mention the overall workflow. The first step is to standardize all of the data
so that later steps can work correctly. Next step is to estimate the network
of the metabolic data and convert it into an edge table with columns indicating
the start and end nodes for each pair of connected nodes. Finally, both the
standardized data and the edge table are put into the main estimation function.

The final graphical model output can allow for visual inference of the potential
pathways. For instance, in this example figure, NetCoupler might classify
two direct effects, represented by the thicker lines with arrowheads, 
and two ambigious effects, represented by the thinner lines, between an exposure or
an outcome and individual metabolic variables. Here, we can then visually trace
the pathway from the exposure, through the metabolic variables, and to the outcome,
and infer that the metabolic variables along this path, here marked as red, might
be along the causal pathway between exposure and outcome.
